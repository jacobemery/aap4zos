- name: Reset password on z/OS RACF.
  hosts: zos_host
  environment: "{{ environment_vars }}"
  gather_facts: false
  tasks:
    - name: Generate temporary password.
      ansible.builtin.set_fact:
        temp_passwd: "{{ lookup('ansible.builtin.password', '/dev/null', chars=['ascii_uppercase', 'digits'], length=8) }}"
      no_log: true

    - name: Execute TSO command to reset password on RACF using temporary password.
      ibm.ibm_zos_core.zos_tso_command:
        commands: "ALU {{ userid | upper }} RESUME PASSWORD({{ temp_passwd }})"
        max_rc: 0
      register: passwd_reset
      no_log: true

    - name: List user to verify passdate age.
      ibm.ibm_zos_core.zos_tso_command:
        commands: "LU {{ userid | upper }}"
        max_rc: 0
      register: listuser
      failed_when: "'PASSDATE=00.000' not in listuser.output"

    # - name: Send email to user with their temporary password.
    #   community.general.mail:
    #     host: <redacted>
    #     port: 25
    #     from: "<redacted>"
    #     to: "{{ tower_user_name }}"
    #     subject: "Password reset details on {{ inventory_hostname }}."
    #     body: >
    #       HOST: {{ inventory_hostname }}
    #       USERID: {{ userid | upper }}
    #       TEMP PASSWD: {{ temp_passwd }}
    #   no_log: true
